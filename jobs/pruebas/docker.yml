# Crear imagen docker usando el Dockerfile del proyecto
# y registrarla en el giltlab container registry
docker-job:
  stage: dockimage

  image: docker:20.10.17
  services:
    - docker:20.10.17-dind

  #rules:
  #  - if: $COMMIT_REF_NAME == "master"
  #- if: $COMMIT_REF_NAME == "develop"

  cache:
    paths:
      - ./target

  script:
    - 'echo "=============================================================================================="'
    - 'echo "Ejecutando etapa DOCKER en $CI_COMMIT_REF_NAME"'
    - 'echo "=============================================================================================="'
    - 'echo "PRJ_VERS: $PRJ_VERS"'
    - '[[ -f "Dockerfile" ]] || { echo "INFO: No existe Dockerfile. Esta etapa no se ejecuta"; exit 0; }'
    - 'IMG_TAG="${CI_REGISTRY_IMAGE}:${PRJ_VERS}"'
    - 'echo "IMG_TAG: $IMG_TAG"'
    - 'docker --version'
    - 'echo "CICD_REGISTRY_HOST: $CICD_REGISTRY_HOST"'
    - 'echo "$CICD_PASSWD" | docker login -u $CICD_USER --password-stdin $CICD_REGISTRY_HOST'
    - 'docker search $IMG_TAG'
    - 'docker build -t $IMG_TAG .'
    - 'docker push $IMG_TAG' 
