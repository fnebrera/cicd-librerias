# Crear un tag sobre el resultado del pipeline
tag-job:
  stage: tag

  variables:
    SEGUIR: "false"

  rules:
    # Hacemos tag en develop solo si es SNAPSHOT, y solo manual
    - if: $CI_COMMIT_REF_NAME == "develop" && $IS_SNAPSHOT == "true"
      when: manual
    # Hacemos tag en master solo si es release
    - if: $CI_COMMIT_REF_NAME == "master" && $IS_SNAPSHOT != "true"
    # Excepcionalmente hacemos tag en una rama concreta, pero solo de forma manual
    - if: $CI_COMMIT_REF_NAME == $HOTFIX_BRANCH
      when: manual

  cache:
    paths:
      - ./.m2/repository

  script:
    - 'echo "=============================================================================================="'
    - 'echo "Ejecutando etapa TAG en $CI_COMMIT_REF_NAME"'
    - 'echo "=============================================================================================="'
    - '[[ $CI_COMMIT_REF_NAME != "master" && $SEGUIR != "true" ]] && { echo "ERROR: Para ejecutar este job debe establecer la variable SEGUIR a true"; exit 1; }'
    - 'TAG="${CI_COMMIT_REF_NAME}-${PRJ_VERS}"'
    - 'echo "Creando tag $TAG en ORIGIN_URL: ${ORIGIN_URL}"'
    - git config user.name "$CICD_USER"
    - git config user.email "$CICD_EMAIL"
    - git remote remove origin
    - git remote add origin ${ORIGIN_URL}
    - git tag -a $TAG -m "Build $TAG"
    - git push origin $TAG
