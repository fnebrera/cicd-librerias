#########################################################################################################
# Esta primera estapa del pipeline se ejecuta de manera incondicional, y se encarga de preparar la cache
# y las variables de entorno que se vayan a emplear en subsiguientes etapas. En el ejemplo actual,
# podría incluirse en el job "compile" y ahorrarnos una etapa, pero lo dejamos a efectos didácticos.
#
# Vers  Por Fecha      Notas
# ----- --- ---------- ----------------------------------------------------------------------------------
# 1.0.0 FNG 22/08/2022 Version inicial
# 1.0.2 FNG 05/10/2022 Transformar en un unico script y emplear libreria bash
#
#########################################################################################################
prepare-job:
  stage: prepare

  cache:
    paths:
      - ./.m2/repository
      - ./.sonar/cache
      - ./target
      - ./cicd.vars

  before_script:
    - . funciones-bash.sh

  script:
    - |
      echo_job_banner PREPARE
      #
      # Version del proyecto
      #
      PRJ_VERS=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.version -q -DforceStdout)
      [[ -z ${PRJ_VERS} ]] && { echo "ERROR: No se ha encontrado la version del proyecto en el pom.xml"; exit 2; }
      echo "Version del proyecto: ${PRJ_VERS}"
      #
      # Nombre del proyecto
      #
      PRJ_NAME=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.name -q -DforceStdout)
      [[ -z ${PRJ_NAME} ]] && { echo "ERROR: No se ha encontrado el nombre del proyecto en el pom.xml"; exit 2; }
      echo "Nombre del proyecto: ${PRJ_NAME}"
      #
      # Es un proyecto Docker?
      #
      IS_DOCKER_PRJ="false"
      [[ -f "Dockerfile" ]] && IS_DOCKER_PRJ="true"
      echo "¿Es un proyecto Docker?: ${IS_DOCKER_PRJ}"
      #
      # Es una version SNAPSHOT?
      #
      IS_SNAPSHOT="false"
      [[ $PRJ_VERS == *"SNAPSHOT" ]] && IS_SNAPSHOT="true"
      echo "¿Es un SNAPSHOT?: ${IS_SNAPSHOT}"
      #
      # Obtener las claves de los registries
      #
      get_registry_tags
      echo "Version para registry: $REG_VERSION"
      echo "Imagen docker: $DOCKER_IMG_TAG"
      echo "Nombre de Tag: $TAG_NAME"
      #
      # Guardar las variables de entorno globales en un fichero .env
      #
      echo "PRJ_VERS=$PRJ_VERS" > prepare.env
      echo "PRJ_NAME=$PRJ_NAME" >> prepare.env
      echo "IS_DOCKER_PRJ=$IS_DOCKER_PRJ" >> prepare.env
      echo "IS_SNAPSHOT=$IS_SNAPSHOT" >> prepare.env
      echo "REG_VERSION=$REG_VERSION" >> prepare.env
      echo "DOCKER_IMG_TAG=$DOCKER_IMG_TAG" >> prepare.env
      echo "TAG_NAME=$TAG_NAME" >> prepare.env

  #    
  # Creamos un artefacto que contiene la/s variables/s de entorno, que asi estan
  # automaticamente disponibles para el resto del pipeline.
  #
  artifacts:
    reports:
      dotenv: prepare.env

################################## E O F ##########################################      
