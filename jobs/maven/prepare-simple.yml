#########################################################################################################
# Esta primera estapa del pipeline se ejecuta de manera incondicional, y se encarga de preparar la cache
# y las variables de entorno que se vayan a emplear en subsiguientes etapas.
#
# Vers  Por Fecha      Notas
# ----- --- ---------- ----------------------------------------------------------------------------------
# 1.0.0 FNG 26/07/2022 Version inicial
#
#########################################################################################################
prepare-job:
  stage: prepare

  cache:
    paths:
      - ./.m2/repository
      - target

  script:
    - >
      echo -e "==============================================================================================
      \nEjecutando etapa PREPARE en $CI_COMMIT_REF_NAME
      \n=============================================================================================="
    # PRUEBAS!!!
    - TEST_TAG="registry2.comunytek.com/comunytek/selfweb/selfwebspringboot/snapshot:5.0.6-SNAPSHOT.007"
    - chmod 400 $CICD_SSH_KEY
    - >
      ssh -o StrictHostKeyChecking=no -i ${CICD_SSH_KEY} ${CICD_SSH_DEPLOY_USER}@${CICD_SSH_DEPLOY_HOST} "
      cd selfweb &&
      echo -e "services:" > test.yml &&
      echo -e "    selfweb:" >> test.yml &&
      echo -e "        image: ${TEST_TAG}" >> test.yml &&
      cat test.yml
      "
    #
    # Obtener version del proyecto. Si no lo encuentra, no es un proyecto maven.
    #
    - 'PRJ_VERS=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.version -q -DforceStdout)'
    - '[[ -z ${PRJ_VERS} ]] && { echo "ERROR: No se ha encontrado la version del proyecto en el pom.xml"; exit 2; }'
    - 'echo "Version del proyecto: ${PRJ_VERS}"'
    #
    # Nombre del proyecto
    #
    - 'PRJ_NAME=$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.name -q -DforceStdout)'
    - '[[ -z ${PRJ_NAME} ]] && { echo "ERROR: No se ha encontrado el nombre del proyecto en el pom.xml"; exit 2; }'
    - 'echo "Nombre del proyecto: ${PRJ_NAME}"'
    #
    # Es un proyecto Docker?
    #
    - 'DOCKER_PRJ="false"'
    - '[[ -f "Dockerfile" ]] && DOCKER_PRJ="true"'
    - 'echo "¿Es un proyecto Docker?: ${DOCKER_PRJ}"'
    #
    # Es una version SNAPSHOT?
    #
    - 'IS_SNAPSHOT="false"'
    - '[[ $PRJ_VERS == *"SNAPSHOT" ]] && IS_SNAPSHOT="true"'
    - 'echo "¿Es un SNAPSHOT?: ${IS_SNAPSHOT}"'
    #
    # Limpiar el directorio target, si es que existe (no deberia)
    #
    - '[[ -d "target" ]] && mvn clean'
    #
    # Guardar las variables de entorno globales en un fichero .env
    #
    - 'echo "PRJ_VERS=$PRJ_VERS" > prepare.env'
    - 'echo "PRJ_NAME=$PRJ_NAME" >> prepare.env'
    - 'echo "DOCKER_PRJ=$DOCKER_PRJ" >> prepare.env'
    - 'echo "IS_SNAPSHOT=$IS_SNAPSHOT" >> prepare.env'

  #    
  # Creamos un artefacto que contiene la/s variables/s de entorno, que asi estan
  # automaticamente disponibles para el resto del pipeline
  #
  artifacts:
    reports:
      dotenv: prepare.env

################################## E O F ##########################################      
