#########################################################################################################
# Crear un tag. Por el momento la ejecucion es manual.
# Para que esta etapa se ejecute, se debe entrar manualmente la variable SEGUIR con valor 'true' en el
# momento de lanzar el job.
#
# Vers  Por Fecha      Notas
# ----- --- ---------- ----------------------------------------------------------------------------------
# 1.0.0 FNG 22/08/2022 Version inicial
#
########################################################################################################## Crear imagen docker usando el Dockerfile del proyecto
tag-job:
  stage: tag

  variables:
    SEGUIR: "false"

  rules:
    # PROVISIONAL
    - if: $DEBUG_CD == 'true'
      when: never
    - if: $CI_COMMIT_REF_NAME == "develop" && $REGISTER_DEVELOP == "true" 
      when: manual
    - if: $CI_COMMIT_REF_NAME == "master"
      when: manual

  cache:
    paths:
      - ./.m2/repository

  script:
    - >
      echo -e "==============================================================================================
      \nEjecutando etapa TAG en $CI_COMMIT_REF_NAME
      \n=============================================================================================="
    #
    # Para continuar, debe entrar SEGUIR=true
    #
    - '[[ $SEGUIR != "true" ]] && { echo "WARN: Para ejecutar este job debe establecer la variable SEGUIR a true"; exit 0; }'
    #
    #  Aplicar reglas complejas
    #
    - |
      TAG="wrong-${PRJ_VERS}"
      case ${CI_COMMIT_REF_NAME} in
          master)
              if [[ $IS_SNAPSHOT == "true" ]]; then
                  echo "ERROR: PUSH de <master> en version SNAPSHOT no permitido"
                  exit 2
              fi
              #
              # A 'release' y solo con la version del proyecto.
              #
              TAG="release-${PRJ_VERS}"
              ;;
          develop)
              if [[ $IS_SNAPSHOT == "true" ]]; then
                  #
                  # Va a 'snapshot'
                  #
                  TAG="snapshot-${PRJ_VERS}"
              else
                  if [[ $ALLOW_RELEASE_IN_DEVELOP != "true" ]]; then
                    echo "ERROR: PUSH de <develop> en version RELEASE no permitido"
                    exit 2
                  fi
                  #
                  # Va a 'develop-release'
                  #
                  TAG="develop-release-${PRJ_VERS}"
              fi
              #
              # Sea snapshot o release, en develop siempre agregamos el numero de snapshot, si existe
              #
              [[ -z $SNAPSHOT_NUMBER ]] || TAG="${TAG}.${SNAPSHOT_NUMBER}"
              ;;
          *)
              echo "ERROR: Rama ${CI_COMMIT_REF_NAME} no puede pasar etapa Tag"
              exit 2          
              ;;
      esac
    - 'echo "Creando tag $TAG en ORIGIN_URL: ${ORIGIN_URL}"'
    - git config user.name "$CICD_USER"
    - git config user.email "$CICD_EMAIL"
    - git remote remove origin
    - git remote add origin ${ORIGIN_URL}
    - git tag -a $TAG -m "Build $TAG"
    - git push origin $TAG

################################## E O F ##########################################    
