#########################################################################################################
# Conecta con el host de destino del deploy y regenera el docker-compose
# usando la imagen generada en la etapa docker.
# SÃ³lo se ejecuta en master.
# Para que esta etapa se ejecute, se debe entrar manualmente la variable SEGUIR con valor 'true' en el
# momento de lanzar el job.
#
# Vers  Por Fecha      Notas
# ----- --- ---------- ----------------------------------------------------------------------------------
# 1.0.0 FNG 22/08/2022 Version inicial
# 1.0.1 FNG 06/09/2022 Se incorporan resultados de Terraform
#
#########################################################################################################
deploy-job:
  stage: deploy

  variables:
    SEGUIR: "false"

  rules:
    # Hacemos deploy solo en master, y en manual
    - if: $CI_COMMIT_REF_NAME == "master"
      when: manual
    # Para DEBUG
    - if: $CI_COMMIT_REF_NAME == "dev-fng" && $DEBUG_CD == "true"
      when: manual

  before_script:
    # Definir prmisos estrictos en la clave privada
    - chmod 400 $DEPLOY_SSH_KEY

  script:
    - >
      echo -e "==============================================================================================
      \nEjecutando etapa DEPLOY en $CI_COMMIT_REF_NAME
      \n=============================================================================================="
    #
    # Para continuar, debe entrar SEGUIR=true
    #
    - '[[ $SEGUIR != "true" ]] && { echo "WARN: Para ejecutar este job debe establecer la variable SEGUIR a true"; exit 0; }'
    - 'echo "DOCKER_PRJ: ${DOCKER_PRJ}"'
    - 'echo "IMG_TAG: ${IMG_TAG}"'
    - 'echo "TF_VM_IP: $TF_VM_IP"'
    # Solo si es un proyecto Docker
    - '[[ $DOCKER_PRJ != "true" ]] && { echo "WARN: No existe Dockerfile. Esta etapa no se ejecuta."; exit 0; }'
    # DEPLOY_SSH_USER y DEPLOY_SSH_KEY son valiables del proyecto, y TF_VM_IP nos la ha devuelto la etapa tf-apply
    - '[[ -z $TF_VM_IP ]] && { echo "ERROR: No existe la variable TF_VM_IP. No se puede continuar con el deploy."; exit 1; }'
    - >
      CONN_STRING="${DEPLOY_SSH_USER}@${TF_VM_IP}"
      ssh -o StrictHostKeyChecking=no -i ${DEPLOY_SSH_KEY} ${CONN_STRING} "
      #cd $DEPLOY_SSH_PATH &&
      #docker-compose down &&
      #echo 'services:' > docker-compose.override.yml &&
      #echo '    ${DOCKER_SERVICE_NAME}:' >> docker-compose.override.yml &&
      #echo '        image: ${IMG_TAG}' >> docker-compose.override.yml &&
      #docker-compose up -d &&
      docker ps
      "

################################## E O F ##########################################    

