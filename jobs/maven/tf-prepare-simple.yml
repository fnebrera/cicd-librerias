#########################################################################################################
# Prepara el provisionado terraform, incluyendo el plan, para que pueda ser revisado antes de lanzar
# el apply.
# SÃ³lo se ejecuta en master.
#
# Vers  Por Fecha      Notas
# ----- --- ---------- ----------------------------------------------------------------------------------
# 1.0.1 FNG 07/09/2022 Version inicial
#
#########################################################################################################
tf-prepare-job:
  stage: tf-prepare

  image: registry.gitlab.com/gitlab-org/terraform-images/releases/1.2:v0.43.1

  rules:
    - if: $CI_COMMIT_REF_NAME == "dev-fng"

  #cache:
  #  paths:
  #    - ./terraform/.terraform

  script:
    - cd terraform
    #- gitlab-terraform validate
    - >
      [[ -d .terraform ]] || 
      gitlab-terraform init
        -backend-config=\""address=$TF_ADDRESS"\"
        -backend-config=\""lock_address=$TF_ADDRESS/lock"\" 
        -backend-config=\""unlock_address=$TF_ADDRESS/lock"\"
        -backend-config=\""username=$TF_USERNAME"\"
        -backend-config=\""password=$TF_PASSWORD"\"
        -backend-config=\""lock_method=POST"\"
        -backend-config=\""unlock_method=DELETE"\"
        -backend-config=\""retry_wait_min=5"\"
    - gitlab-terraform plan

################################## E O F ##########################################

