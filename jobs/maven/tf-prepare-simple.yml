#########################################################################################################
# Prepara el provisionado terraform, incluyendo el plan, para que pueda ser revisado antes de lanzar
# el apply.
# No usamos gitlab-terraform porque en este proyecto no nos aporta nada, más bien nos lía. Si
# se quiere volver a usar, basta con sustituir los comandos 'gitlab-terraform' por 'terraform'.
# IMPORTANTE: Por elmomento sólo se ejecuta en master.
#
# Vers  Por Fecha      Notas
# ----- --- ---------- ----------------------------------------------------------------------------------
# 1.0.1 FNG 19/09/2022 Version inicial
#
#########################################################################################################
tf-prepare-job:
  stage: tf-prepare

  image: registry.gitlab.com/gitlab-org/terraform-images/releases/1.2:v0.43.1

  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
    # DEBUG QUITAR !!!!!!!!!!!!!!!!!!!!!!
    - if: $CI_COMMIT_REF_NAME == "dev-fng" && $DEBUG_CD == "true"

  cache:
    paths:
      - .terraform.lock.hcl
      - .terraform

  script:
    - >
      echo -e "==============================================================================================
      \nEjecutando etapa TF_PREPARE en $CI_COMMIT_REF_NAME
      \n=============================================================================================="
    - cd $TF_ROOT
    - |
      echo "----------------------------------------------------------------------------------------"
      echo "INFO Inicializando Terraform usando el backed Gitlab.."
      echo "----------------------------------------------------------------------------------------"
      terraform init -input=false -reconfigure \
      -backend-config="username=$CICD_USER" \
      -backend-config="password=$CICD_TOKEN" \
      -backend-config="address=$TF_BACKED_ADDRESS" \
      -backend-config="lock_address=$TF_BACKED_ADDRESS/lock" \
      -backend-config="unlock_address=$TF_BACKED_ADDRESS/lock" \
      -backend-config="lock_method=POST" \
      -backend-config="unlock_method=DELETE" \
      -backend-config="retry_wait_min=5"
      echo "----------------------------------------------------------------------------------------"
      echo "INFO Verificando configuración de terraform"
      echo "----------------------------------------------------------------------------------------"
      terraform validate
      echo "----------------------------------------------------------------------------------------"
      echo "INFO Creando el plan de despliegue"
      echo "----------------------------------------------------------------------------------------"
      terraform plan -input=false -out="plan.cache"
      echo "=============================================================================================="
      echo "INFO Etapa TF_PREPARE finalizada con exito"
      echo "=============================================================================================="

  artifacts:
    name: "Selfweb terraform plan"
    paths:
      - ${TF_ROOT}/plan.cache
    expire_in: 1 hour

################################## E O F ##########################################

