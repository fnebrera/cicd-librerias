#########################################################################################################
# Prepara el provisionado terraform, incluyendo el plan, para que pueda ser revisado antes de lanzar
# el apply.
# SÃ³lo se ejecuta en master.
#
# Vers  Por Fecha      Notas
# ----- --- ---------- ----------------------------------------------------------------------------------
# 1.0.1 FNG 07/09/2022 Version inicial
#
#########################################################################################################
tf-prepare-job:
  stage: tf-prepare

  image: registry.gitlab.com/gitlab-org/terraform-images/releases/1.2:v0.43.1

  rules:
    - if: $CI_COMMIT_REF_NAME == "dev-fng"

  cache:
    paths:
      - $TF_ROOT/.terraform.lock.hcl

  script:
    - >
      echo -e "==============================================================================================
      \nEjecutando etapa TF_PREPARE en $CI_COMMIT_REF_NAME
      \n=============================================================================================="
    - cd $TF_ROOT
    # DEBUG forzamos limpieza del archivo .terraform del cache
    - '[[ -d .terraform ]] && rm -Rf .terraform'
    - |
      if ! [[ -f .terraform.lock.hcl ]]; then
        echo "INFO: No existe el archivo .terraform.lock.hcl, llamamos a terraform init"
        gitlab-terraform init \
          -backend-config="username=$TF_USERNAME" \
          -backend-config="password=$TF_PASSWORD" \
          -backend-config="address=$TF_ADDRESS" \
          -backend-config="lock_address=$TF_ADDRESS/lock" \
          -backend-config="unlock_address=$TF_ADDRESS/lock" \
          -backend-config="lock_method=POST" \
          -backend-config="unlock_method=DELETE"
      fi
      echo "INFO: Creando el plan de despliegue"
      gitlab-terraform plan
      gitlab-terraform plan-json
      # DEBUG mostrar contenido del directorio, incluyendo el cache
      [[ ${DEBUG_CD} == "true" ]] && { echo "INFO: El contenido actual de TF_ROOT es:"; ls -al; }

  artifacts:
    name: "Selfweb terraform plan"
    paths:
      - ${TF_ROOT}/plan.cache
    reports:
      terraform: ${TF_ROOT}/plan.json
    expire_in: 1 hour

################################## E O F ##########################################

