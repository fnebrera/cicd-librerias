#########################################################################################################
# Crea la imagen docker en base al Dockerfile, y la sube al Component Registry del ropio gitlab.
# Normalmente se ejecuta en paralelo al job "pkg-register-job".
# Para que este job funcione, el Pacjage Registry debe estar configurado en el pom.xml.
# Se ejecuta solo para ramas master y develop.
# Se cachea el directorio /target, que habra sido populado previamente por la etapa build.
#
# Vers  Por Fecha      Notas
# ----- --- ---------- ----------------------------------------------------------------------------------
# 1.0.0 FNG 26/07/2022 Version inicial
#
########################################################################################################## Crear imagen docker usando el Dockerfile del proyecto
docker-register-job:
  stage: docker

  image: docker:20.10.17
  services:
    - docker:20.10.17-dind

  rules:
    # Solo si hay Dockerfile
    - if: $DOCKER_PRJ != "true"
      when: never
    # Hacemos docker en develop solo si es SNAPSHOT
    - if: $CI_COMMIT_REF_NAME == "develop" && $IS_SNAPSHOT == "true"
    # Hacemos docker en master solo si es release
    - if: $CI_COMMIT_REF_NAME == "master" && $IS_SNAPSHOT != "true"
    # Excepcionalmente hacemos docker en una rama concreta
    - if: $CI_COMMIT_REF_NAME == $HOTFIX_BRANCH


  cache:
    paths:
      - target

  script:
    - >
      echo -e "==============================================================================================
      \nEjecutando etapa DOCKER en $CI_COMMIT_REF_NAME
      \n=============================================================================================="
    # Esto es redundante, pero porsi acaso..
    - '[[ -f "Dockerfile" ]] || { echo "INFO: No existe Dockerfile. Esta etapa no se ejecuta"; exit 0; }'
    - '[[ -z ${PRJ_VERS} ]] && { echo "ERROR: No se ha encontrado la version del proyecto en el pom.xml"; exit 2; }'
    - 'IMG_TAG="${CI_REGISTRY_IMAGE}/release:${PRJ_VERS}"'
    - '[[ $IS_SNAPSHOT == "true" ]] && IMG_TAG="${CI_REGISTRY_IMAGE}/snapshot:${PRJ_VERS}"'
    - 'echo "IMG_TAG: $IMG_TAG"'
    - 'docker --version'
    - 'echo "$CICD_PASSWD" | docker login -u $CICD_USER --password-stdin $CICD_REGISTRY_HOST'
    - 'docker build -t $IMG_TAG .'
    - 'docker push $IMG_TAG' 
